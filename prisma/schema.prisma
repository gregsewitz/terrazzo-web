generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ──────────────────────────────────────────────
// Existing models
// ──────────────────────────────────────────────

model User {
  id           String       @id @default(cuid())
  email        String       @unique
  name         String?
  tasteProfile Json?        // TasteProfile
  nylasGrants  NylasGrant[]
  trips        Trip[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model NylasGrant {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantId   String   @unique
  email     String
  provider  String   @default("google")
  createdAt DateTime @default(now())
}

model Trip {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  location  String
  startDate DateTime?
  endDate   DateTime?
  days      Json     // TripDay[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  places    Place[]
}

model Place {
  id             String   @id @default(cuid())
  tripId         String
  trip           Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  name           String
  type           String
  googlePlaceId  String?
  location       String?
  googleData     Json?    // GooglePlaceData
  source         Json     // ImportSource
  matchScore     Int?
  matchBreakdown Json?    // TasteProfile
  tasteNote      String?
  enrichment     Json?    // PlaceEnrichment
  status         String   @default("available")
  placedIn       Json?    // { day: number; slot: string }
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Link to global intelligence
  placeIntelligenceId String?
  intelligence        PlaceIntelligence? @relation(fields: [placeIntelligenceId], references: [id])
}

model PlaceCache {
  id            String   @id @default(cuid())
  googlePlaceId String   @unique
  data          Json     // Full Google Places response
  fetchedAt     DateTime @default(now())

  @@index([googlePlaceId])
}

// ──────────────────────────────────────────────
// Place Intelligence (global, one per property)
// ──────────────────────────────────────────────

model PlaceIntelligence {
  id              String   @id @default(cuid())
  googlePlaceId   String   @unique
  propertyName    String

  // Pipeline status
  status          String   @default("pending") // pending | enriching | complete | failed
  pipelineVersion String   @default("v3-ri")

  // Core intelligence payload
  signals         Json     @default("[]") // Signal[]
  antiSignals     Json?    // AntiSignal[]
  reliability     Json?    // { overall, categories, totalReviews }
  facts           Json?    // { location, roomCount, architect, ... }
  reviewIntel     Json?    // { tier2, tier3, corroboration stats }

  // Quick-access counts
  signalCount      Int     @default(0)
  antiSignalCount  Int     @default(0)
  reviewCount      Int     @default(0)
  reliabilityScore Float?  // 0-1

  // Sources processed
  sourcesProcessed Json?

  // Freshness
  lastEnrichedAt  DateTime?
  enrichmentTTL   Int      @default(90) // days

  // Relations
  pipelineRuns    PipelineRun[]
  places          Place[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([googlePlaceId])
  @@index([status])
}

// ──────────────────────────────────────────────
// Pipeline Run (execution tracking)
// ──────────────────────────────────────────────

model PipelineRun {
  id                  String   @id @default(cuid())
  placeIntelligenceId String
  placeIntelligence   PlaceIntelligence @relation(fields: [placeIntelligenceId], references: [id])

  status              String   @default("queued") // queued | running | complete | failed
  triggerSource       String   // user_import | manual | refresh | backfill
  triggeredByUserId   String?

  currentStage        String?
  stagesCompleted     Json?    // string[]

  startedAt           DateTime?
  completedAt         DateTime?
  durationMs          Int?

  error               String?
  retryCount          Int      @default(0)

  createdAt           DateTime @default(now())

  @@index([placeIntelligenceId])
  @@index([status])
}
