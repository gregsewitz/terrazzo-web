generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ──────────────────────────────────────────────
// User & Auth
// ──────────────────────────────────────────────

model User {
  id                   String       @id @default(cuid())
  supabaseId           String       @unique
  email                String       @unique
  name                 String?
  authProvider         String       @default("email")

  // Taste profile (from onboarding)
  tasteProfile         Json?        // GeneratedProfile
  lifeContext          Json?        // { primaryCompanions, firstName, etc. }
  allSignals           Json?        // Signal[]
  allContradictions    Json?        // Contradiction[]
  seedTrips            Json?        // SeedTripInput[]
  trustedSources       Json?        // TrustedSource[]
  mosaicData           Json?        // { answers: MosaicAnswer[], axes: Record<string,number> }
  isOnboardingComplete Boolean      @default(false)
  onboardingDepth      String?      // shallow | standard | deep

  // Relations
  nylasGrants          NylasGrant[]
  trips                Trip[]
  savedPlaces          SavedPlace[]
  shortlists           Shortlist[]
  shareLinks           ShareLink[]

  // Collaboration relations
  tripCollaborations   TripCollaborator[]
  tripSuggestions      TripSuggestion[]
  tripReactions        TripReaction[]
  slotNotes            SlotNote[]

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  @@index([supabaseId])
}

model NylasGrant {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  grantId   String   @unique
  email     String
  provider  String   @default("google")
  createdAt DateTime @default(now())
}

// ──────────────────────────────────────────────
// Saved Places & Collections (Library tab)
// ──────────────────────────────────────────────

model SavedPlace {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Place identity
  googlePlaceId       String?
  name                String
  type                String   // restaurant | hotel | bar | cafe | museum | activity | neighborhood | shop
  location            String?

  // Import metadata (provenance — write-once, never overwritten by re-imports)
  source              Json?    // { type, name, url } — ImportSource (primary/first source)
  ghostSource         String?  // friend | maps | article | email | ai | manual | instagram
  friendAttribution   Json?    // { name, platform, date }
  userContext          String?  // user's personal note about the place
  timing              String?
  travelWith          String?  // e.g. "bestie", "daughter", "friends"
  intentStatus        String?  // booked | planning | dreaming | researching
  savedDate           String?  // e.g. "Saved Jun 2024"
  importBatchId       String?  // links places from same import
  importSources       Json     @default("[]") // ImportSourceEntry[] — append-only provenance log

  // Ratings
  rating              Json?    // { reaction, tags, contextTags, returnIntent, personalNote }
  isFavorited         Boolean  @default(false) @map("isShortlisted")

  // Enrichment data
  enrichment          Json?    // { closedDays, hours, seasonalNote, priceRange, description, confidence }
  whatToOrder          Json?    // string[] — e.g. ["Puntillas ★", "Gambas de la santa"]
  tips                Json?    // string[] — e.g. ["Go early", "Drink at the bar"]
  alsoKnownAs         String?  // e.g. "El Sótano"

  // Taste matching
  matchScore          Int?
  matchBreakdown      Json?    // { Design, Character, Service, Food, Location, Wellness }
  tasteNote           String?
  terrazzoInsight     Json?    // { why, caveat }

  // Google data cache
  googleData          Json?

  // Link to global intelligence
  placeIntelligenceId String?
  intelligence        PlaceIntelligence? @relation("SavedPlaceIntelligence", fields: [placeIntelligenceId], references: [id])

  // Soft delete
  deletedAt           DateTime?          // null = active; set = soft-deleted (30-day recovery)

  // Relations
  collections         CollectionPlace[]
  tripPlaceRefs       Place[]            @relation("LibraryPlaceRef")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, googlePlaceId])
  @@index([userId])
  @@index([googlePlaceId])
  @@index([deletedAt])
  @@index([type])
  @@index([matchScore])
}

// Design notes:
// - Collections with 0 places are valid — don't auto-delete. The user named it intentionally.
// - Offline/conflict strategy for placeIds:
//     Metadata (name, emoji, description): last-write-wins.
//     Membership (placeIds): append-only merge — resolve conflicts by union of both arrays.
//     This means a place added offline by the user will never be lost on sync, even if
//     the server version diverged. Implement in the sync layer when offline support ships.

model Shortlist {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name              String
  description       String?
  emoji             String   @default("sparkle")
  isDefault         Boolean  @default(false)   // true for "Favorites"
  isSmartCollection Boolean  @default(false)

  // Smart collection config
  query             String?
  filterTags        Json?    // string[]

  // Place membership — legacy JSON array kept as read cache for offline-first
  // Source of truth is now CollectionPlace join table below
  placeIds          Json     @default("[]")     // string[] (read cache)

  places            CollectionPlace[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
}

// Join table: which SavedPlaces belong to which Shortlists (collections)
// Replaces the denormalized placeIds JSON array as the source of truth.
// Enables: "which collections is this place in?", referential integrity, addedAt tracking.
model CollectionPlace {
  id            String     @id @default(cuid())
  collectionId  String
  collection    Shortlist  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  placeId       String
  place         SavedPlace @relation(fields: [placeId], references: [id], onDelete: Cascade)

  addedAt       DateTime   @default(now())

  @@unique([collectionId, placeId])
  @@index([placeId])       // "which collections is this place in?"
  @@index([collectionId])  // "which places are in this collection?"
}

// ──────────────────────────────────────────────
// Trips (Plan tab)
// ──────────────────────────────────────────────

model Trip {
  id           String    @id @default(cuid())
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name         String
  location     String
  destinations Json?     // string[]
  startDate    DateTime?
  endDate      DateTime?
  groupSize    Int?
  groupType    String?   // partner | friends | family | solo
  vibe         String?

  // Full trip state (mirrors TripDay[] from Zustand)
  days         Json      // TripDay[]
  pool         Json?     // PoolItem[] — unplaced items

  // Conversation history
  conversationHistory Json? // Message[]

  status       String    @default("planning") // planning | active | completed

  // Collaboration relations
  collaborators       TripCollaborator[]
  suggestions         TripSuggestion[]
  reactions           TripReaction[]
  slotNotes           SlotNote[]
  activities          TripActivity[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  places       Place[]

  @@index([userId])
}

model Place {
  id             String   @id @default(cuid())
  tripId         String
  trip           Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  name           String
  type           String
  googlePlaceId  String?
  location       String?
  googleData     Json?    // GooglePlaceData
  source         Json     // ImportSource
  matchScore     Int?
  matchBreakdown Json?    // TasteProfile
  tasteNote      String?
  enrichment     Json?    // PlaceEnrichment
  status         String   @default("available")
  placedIn       Json?    // { day: number; slot: string }

  // Library reference — links this trip place back to the canonical SavedPlace
  libraryPlaceId String?
  libraryPlace   SavedPlace? @relation("LibraryPlaceRef", fields: [libraryPlaceId], references: [id], onDelete: SetNull)

  // Attribution — who added this place to the trip
  addedByUserId  String?  // null = trip owner; set when a collaborator adds it
  addedByName    String?  // denormalized display name for "Added by Sarah"

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Link to global intelligence
  placeIntelligenceId String?
  intelligence        PlaceIntelligence? @relation("TripPlaceIntelligence", fields: [placeIntelligenceId], references: [id])

  @@index([libraryPlaceId])
}

// ──────────────────────────────────────────────
// Share Links (public sharing)
// ──────────────────────────────────────────────

model ShareLink {
  id            String    @id @default(cuid())
  token         String    @unique @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  resourceType  String    // "shortlist" | "trip"
  resourceId    String    // ID of the shortlist or trip

  permission    String    @default("view") // "view" | "edit"
  isActive      Boolean   @default(true)
  viewCount     Int       @default(0)
  expiresAt     DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([token])
  @@index([resourceType, resourceId])
  @@index([userId])
}

// ──────────────────────────────────────────────
// Trip Collaboration
// ──────────────────────────────────────────────

model TripCollaborator {
  id          String    @id @default(cuid())
  tripId      String
  trip        Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  role        String    @default("suggester") // "viewer" | "suggester"
  status      String    @default("pending")   // "pending" | "accepted" | "declined"
  invitedBy   String                          // userId of inviter
  inviteToken String    @unique @default(cuid())

  invitedAt   DateTime  @default(now())
  acceptedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
  @@index([inviteToken])
}

model TripSuggestion {
  id            String    @id @default(cuid())
  tripId        String
  trip          Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Place data
  googlePlaceId String?   // Links to PlaceIntelligence for enrichment
  placeName     String
  placeType     String
  placeLocation String?
  placeData     Json?     // Full ImportedPlace-like payload (legacy; prefer googlePlaceId)

  // Target slot
  targetDay     Int
  targetSlotId  String    // "breakfast", "lunch", "dinner", etc.

  // Collaborator's note
  reason        String?   // "You'd love this — amazing courtyard"

  // Owner response
  status        String    @default("pending") // "pending" | "accepted" | "rejected"
  respondedAt   DateTime?

  createdAt     DateTime  @default(now())

  @@index([tripId])
  @@index([userId])
  @@index([status])
}

model TripReaction {
  id          String   @id @default(cuid())
  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  placeKey    String   // "dayNumber-slotId-placeName" composite key
  reaction    String   // "love" | "not_for_me"
  note        String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([tripId, userId, placeKey])
  @@index([tripId])
}

model SlotNote {
  id          String   @id @default(cuid())
  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  dayNumber   Int
  slotId      String
  content     String   // "I booked 8pm reservation"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tripId])
}

model TripActivity {
  id          String   @id @default(cuid())
  tripId      String
  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userId      String?  // null for system actions
  type        String   // "collaborator_joined" | "suggestion_added" | "suggestion_accepted" | "reaction_added" | "note_added" | "place_moved"
  summary     String   // Human-readable: "Alice suggested Noma for Day 2 lunch"
  data        Json?    // Structured payload for UI rendering

  createdAt   DateTime @default(now())

  @@index([tripId])
  @@index([createdAt])
}

// ──────────────────────────────────────────────
// Waitlist
// ──────────────────────────────────────────────

model WaitlistEntry {
  id             String   @id @default(cuid())
  email          String   @unique
  referralSource String?  // how they heard about Terrazzo
  createdAt      DateTime @default(now())

  @@index([email])
}

// ──────────────────────────────────────────────
// Caches
// ──────────────────────────────────────────────

model PlaceCache {
  id            String   @id @default(cuid())
  googlePlaceId String   @unique
  data          Json     // Full Google Places response
  fetchedAt     DateTime @default(now())

  @@index([googlePlaceId])
}

// ──────────────────────────────────────────────
// Place Intelligence (global, one per property)
// ──────────────────────────────────────────────

model PlaceIntelligence {
  id              String   @id @default(cuid())
  googlePlaceId   String   @unique
  propertyName    String

  // Pipeline status
  status          String   @default("pending") // pending | enriching | complete | failed
  pipelineVersion String   @default("v3-ri")

  // Core intelligence payload
  signals         Json     @default("[]") // Signal[]
  antiSignals     Json?    // AntiSignal[]
  reliability     Json?    // { overall, categories, totalReviews }
  facts           Json?    // { location, roomCount, architect, ... }
  reviewIntel     Json?    // { tier2, tier3, corroboration stats }

  // Quick-access counts
  signalCount      Int     @default(0)
  antiSignalCount  Int     @default(0)
  reviewCount      Int     @default(0)
  reliabilityScore Float?  // 0-1

  // Sources processed
  sourcesProcessed Json?

  // Freshness
  lastEnrichedAt  DateTime?
  enrichmentTTL   Int      @default(90) // days

  // Relations
  pipelineRuns    PipelineRun[]
  tripPlaces      Place[]       @relation("TripPlaceIntelligence")
  savedPlaces     SavedPlace[]  @relation("SavedPlaceIntelligence")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([googlePlaceId])
  @@index([status])
}

// ──────────────────────────────────────────────
// Pipeline Run (execution tracking)
// ──────────────────────────────────────────────

model PipelineRun {
  id                  String   @id @default(cuid())
  placeIntelligenceId String
  placeIntelligence   PlaceIntelligence @relation(fields: [placeIntelligenceId], references: [id])

  status              String   @default("queued") // queued | running | complete | failed
  triggerSource       String   // user_import | manual | refresh | backfill
  triggeredByUserId   String?

  currentStage        String?
  stagesCompleted     Json?    // string[]

  startedAt           DateTime?
  completedAt         DateTime?
  durationMs          Int?

  error               String?
  retryCount          Int      @default(0)

  createdAt           DateTime @default(now())

  @@index([placeIntelligenceId])
  @@index([status])
}
